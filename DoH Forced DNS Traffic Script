# DoH Forced DNS Traffic Script
#get gateway ip
:global gatewayip [/ip dhcp-server network get 0 gateway]
#Force redirect of destination of all TCP/UDP port 53(DNS) traffic from local address list to gateway (be sure to set gateway DNS server IP address to the correct DNS server)
/ip firewall nat add chain=dstnat src-address-list="local" protocol=udp dst-port=53 action=dst-nat to-addresses=$gatewayip to-ports=53 comment="Redirect all Traffic on DNSport to DNSFilter" place-before=0
/ip firewall nat add chain=dstnat src-address-list="local" protocol=tcp dst-port=53 action=dst-nat to-addresses=$gatewayip to-ports=53 comment="Redirect all Traffic on DNSport to DNSFilter" place-before=0
/ip firewall nat add chain=dstnat src-address-list="local" protocol=udp dst-port=53 action=dst-nat to-addresses=$gatewayip to-ports=53 comment="Redirect all Traffic on DNSport to DNSFilter" place-before=0
/ip firewall nat add chain=dstnat src-address-list="local" protocol=tcp dst-port=53 action=dst-nat to-addresses=$gatewayip to-ports=53 comment="Redirect all Traffic on DNSport to DNSFilter" place-before=0
/log info "DoH NAT Rules Applied"
#Block all traffic to DoH providers
/ip firewall filter
add action=reject chain=forward comment="Block rule for DoH List " dst-address-list=DNSoHTTPS log=yes reject-with=icmp-network-unreachable
/log info "DNSoHTTPS Firewall filter rule created"
/log info "Creating DNSoHTTPS Address list"
#Create DoH Address list
/ip firewall address-list
# DNS over HTTPS (DoH) server IP list
# This is a list of IPs which correspond to publicly available DoH providers
# It can be used to firewall these IP addresses
# This list was generated by running `dig +short HOSTNAME A`
# Twitter: @oneoffdallas
# Homepage: https://github.com/oneoffdallas/dohservers
# Raw data: https://raw.githubusercontent.com/oneoffdallas/dohservers/master/iplist.txt
#
# Added: 14 Oct 2019
# Last modified: 05 Apr 2021

# Optionally include Cloudflare's main addresses (Google and Quad9 included below)
add address=1.1.1.1 list=DNSoHTTPS 
add address=1.0.0.1 list=DNSoHTTPS 
#
# security.cloudflare-dns.com - see IPs further down this list
add address=1.1.1.2 list=DNSoHTTPS 
add address=1.0.0.2 list=DNSoHTTPS 
#
# family.cloudflare-dns.com
add address=1.1.1.3 list=DNSoHTTPS 
add address=1.0.0.3 list=DNSoHTTPS 

# dns.cloudflare.com
# (optional because cdnjs.cloudflare.com uses the same IPs)
add address=104.16.132.229 list=DNSoHTTPS 
add address=104.16.133.229 list=DNSoHTTPS 

# NOTES
# Quad9 is also using Port 5053 for DoH: (last checked 11 Jan 2020)
# https://www.quad9.net/doh-quad9-dns-servers/#UsingDoHwithQuad9DNSServers-AdditionalInformation
#
# dnscrypt.ca is using Port 453 for DoH (instead of 443)
/ip firewall address-list 
add address=168.235.81.167 list=DNSoHTTPS
add address=176.56.236.175 list=DNSoHTTPS
add address=176.103.130.131 list=DNSoHTTPS 
add address=176.103.130.130 list=DNSoHTTPS 
add address=176.103.130.132 list=DNSoHTTPS 
add address=176.103.130.134 list=DNSoHTTPS 
add address=37.252.185.229 list=DNSoHTTPS 
add address=206.189.215.75 list=DNSoHTTPS 
add address=104.24.120.142 list=DNSoHTTPS 
add address=104.24.121.142 list=DNSoHTTPS 
add address=108.61.201.119 list=DNSoHTTPS 
add address=139.59.48.222 list=DNSoHTTPS 
add address=104.16.249.249 list=DNSoHTTPS 
add address=104.16.248.249 list=DNSoHTTPS 
add address=199.58.81.218 list=DNSoHTTPS 
add address=23.92.29.236 list=DNSoHTTPS 
add address=104.28.0.106 list=DNSoHTTPS 
add address=104.28.1.106 list=DNSoHTTPS 
add address=8.8.4.4 list=DNSoHTTPS 
add address=8.8.8.8 list=DNSoHTTPS 
add address=185.95.218.42 list=DNSoHTTPS 
add address=185.95.218.43 list=DNSoHTTPS 
add address=185.222.222.222 list=DNSoHTTPS 
add address=185.184.222.222 list=DNSoHTTPS 
add address=46.101.66.244 list=DNSoHTTPS 
add address=172.64.108.27 list=DNSoHTTPS 
add address=172.64.109.27 list=DNSoHTTPS 
add address=45.77.124.64 list=DNSoHTTPS 
add address=45.32.253.116 list=DNSoHTTPS 
add address=104.236.178.232 list=DNSoHTTPS 
add address=89.234.186.112 list=DNSoHTTPS 
add address=45.90.28.0 list=DNSoHTTPS 
add address=45.90.30.0 list=DNSoHTTPS 
add address=193.17.47.1 list=DNSoHTTPS 
add address=185.43.135.1 list=DNSoHTTPS 
add address=136.144.215.158 list=DNSoHTTPS 
add address=118.126.68.223 list=DNSoHTTPS 
add address=118.89.110.78 list=DNSoHTTPS 
add address=47.96.179.163 list=DNSoHTTPS 
add address=145.100.185.15 list=DNSoHTTPS 
add address=145.100.185.16 list=DNSoHTTPS 
add address=174.138.29.175 list=DNSoHTTPS 
add address=45.77.180.10 list=DNSoHTTPS 
add address=185.216.27.142 list=DNSoHTTPS 
add address=217.169.20.23 list=DNSoHTTPS 
add address=217.169.20.22 list=DNSoHTTPS 
add address=172.65.3.223 list=DNSoHTTPS 
add address=188.60.252.16 list=DNSoHTTPS 

# *.quad9.net
add address=149.112.112.112 list=DNSoHTTPS 
add address=9.9.9.9 list=DNSoHTTPS 
add address=149.112.112.9 list=DNSoHTTPS 
add address=9.9.9.10 list=DNSoHTTPS 
add address=149.112.112.10 list=DNSoHTTPS 
add address=9.9.9.11 list=DNSoHTTPS 
add address=149.112.112.11 list=DNSoHTTPS 

# dns.oszx.co
add address=51.38.83.141 list=DNSoHTTPS 

# dns.pumplex.com
add address=51.38.82.198 list=DNSoHTTPS 

# arvind.io
add address=206.189.142.179 list=DNSoHTTPS 

# dns.brahma.world
add address=94.237.80.211 list=DNSoHTTPS 

# *.cleanbrowsing.org
add address=185.228.168.9 list=DNSoHTTPS 
add address=185.228.169.9 list=DNSoHTTPS 
add address=185.228.168.10 list=DNSoHTTPS 
add address=185.228.169.11 list=DNSoHTTPS 
add address=185.228.168.168 list=DNSoHTTPS 
add address=185.228.169.168 list=DNSoHTTPS 

# commons.host
add address=139.162.131.245 list=DNSoHTTPS 

# dns2.developer.li
add address=51.89.22.36 list=DNSoHTTPS 

# dns.developer.li
add address=164.132.45.112 list=DNSoHTTPS 

# doh.dns.sb
add address=172.64.105.36 list=DNSoHTTPS 
add address=172.64.104.36 list=DNSoHTTPS 

# doh.ffmuc.net
add address=195.30.94.28 list=DNSoHTTPS 

# geekdns / 233py.com
add address=125.77.154.35 list=DNSoHTTPS 
add address=104.27.164.27 list=DNSoHTTPS 
add address=104.27.165.27 list=DNSoHTTPS 

# 233py's that need to checked
add address=47.101.136.37 list=DNSoHTTPS 
add address=114.115.240.175 list=DNSoHTTPS 
add address=119.29.107.85 list=DNSoHTTPS 
add address=118.24.208.197 list=DNSoHTTPS 

# public.dns.iij.jp
add address=103.2.57.5 list=DNSoHTTPS 
add address=103.2.57.6 list=DNSoHTTPS 

# *.tiar.app
add address=174.138.21.128 list=DNSoHTTPS 
add address=172.104.93.80 list=DNSoHTTPS 

# doh.libredns.org
add address=146.148.56.78 list=DNSoHTTPS 

# doh.netweaver.uk
add address=185.157.233.92 list=DNSoHTTPS 

# dns.twnic.tw
add address=210.17.9.228 list=DNSoHTTPS 

# doh.xfinity.com / doh.gslb2.xfinity.com (Comcast)
add address=96.113.151.141 list=DNSoHTTPS 
add address=96.113.151.142 list=DNSoHTTPS 
add address=96.113.151.143 list=DNSoHTTPS 
add address=96.113.151.147 list=DNSoHTTPS 
add address=96.113.151.148 list=DNSoHTTPS 
add address=96.113.151.149 list=DNSoHTTPS 
add address=96.113.151.150 list=DNSoHTTPS 

# dnscrypt.ca (Port 453!)
add address=167.114.220.125 list=DNSoHTTPS 
add address=149.56.228.45 list=DNSoHTTPS 

# *.ahadns.com
add address=5.2.75.75 list=DNSoHTTPS 
add address=45.79.120.233 list=DNSoHTTPS 
add address=45.67.219.208 list=DNSoHTTPS 
add address=185.213.26.187 list=DNSoHTTPS 
add address=45.132.75.16 list=DNSoHTTPS 
add address=45.91.95.12 list=DNSoHTTPS 
add address=45.132.74.167 list=DNSoHTTPS 
add address=185.175.56.133 list=DNSoHTTPS 
add address=193.29.62.196 list=DNSoHTTPS 
add address=103.73.64.132 list=DNSoHTTPS 

# dns.t53.de (Telekom DE DoH-Testserver)
add address=80.156.145.201 list=DNSoHTTPS 

# snopyta.org
add address=95.216.229.153 list=DNSoHTTPS 

# alekberg.net
add address=51.15.124.208 list=DNSoHTTPS !!
add address=104.168.247.138 list=DNSoHTTPS 
add address=45.153.187.96 list=DNSoHTTPS 

# *.dnslify.com
add address=185.235.81.1 list=DNSoHTTPS 
add address=185.235.81.2 list=DNSoHTTPS 
add address=185.235.81.3 list=DNSoHTTPS 
add address=185.235.81.4 list=DNSoHTTPS 
add address=185.235.81.5 list=DNSoHTTPS 
add address=185.235.81.6 list=DNSoHTTPS 

# opendns.com (Cisco) (Production - Familyshield - Sandbox)
add address=146.112.41.2 list=DNSoHTTPS 
add address=146.112.41.3 list=DNSoHTTPS 
add address=146.112.41.4 list=DNSoHTTPS 
add address=208.67.222.222 list=DNSoHTTPS 
add address=208.67.220.220 list=DNSoHTTPS 
add address=208.67.222.123 list=DNSoHTTPS 
add address=208.67.220.123 list=DNSoHTTPS 
add address=208.67.220.2 list=DNSoHTTPS 
add address=208.67.222.2 list=DNSoHTTPS 

# dnswarden.com
add address=88.198.161.8 list=DNSoHTTPS 
add address=116.203.35.255 list=DNSoHTTPS 
add address=116.203.70.156 list=DNSoHTTPS 

# dohdot.coxlab.net
add address=174.68.248.77 list=DNSoHTTPS 

# dns.hostux.net
add address=185.26.126.37 list=DNSoHTTPS 

#jcdns.fun
add address=178.62.214.105 list=DNSoHTTPS 

# doh.blockerdns.com
add address=35.231.247.227 list=DNSoHTTPS 

# doh.libredns.gr
add address=116.203.115.192 list=DNSoHTTPS 

# doh.defaultroutes.de
add address=5.45.107.88 list=DNSoHTTPS 

# dns.flatuslifir.is
add address=46.239.223.80 list=DNSoHTTPS 

# resolver-eu.lelux.fi
add address=51.158.147.50 list=DNSoHTTPS 

# *.applied-privacy.net
add address=93.177.65.183 list=DNSoHTTPS 
add address=146.255.56.98 list=DNSoHTTPS 

# dnsforge.de
add address=176.9.93.198 list=DNSoHTTPS 
add address=176.9.1.117 list=DNSoHTTPS 

# dohtrial.att.net
add address=13.89.120.251 list=DNSoHTTPS 
add address=40.76.112.230 list=DNSoHTTPS 

# rumpelsepp.org
add address=116.203.179.248 list=DNSoHTTPS 

# dns.nixnet.xyz
add address=198.251.90.114 list=DNSoHTTPS 
add address=198.251.90.89 list=DNSoHTTPS 
add address=209.141.34.95 list=DNSoHTTPS 
add address=199.195.251.84 list=DNSoHTTPS 
add address=104.244.78.231 list=DNSoHTTPS 

# security.cloudflare-dns.com
add address=104.18.2.55 list=DNSoHTTPS 
add address=104.18.3.55 list=DNSoHTTPS 

# family.cloudflare-dns.com
add address=104.18.26.128 list=DNSoHTTPS 
add address=104.18.27.128 list=DNSoHTTPS 

# canadianshield.cira.ca
add address=149.112.121.10 list=DNSoHTTPS 
add address=149.112.122.10 list=DNSoHTTPS 
add address=149.112.121.20 list=DNSoHTTPS 
add address=149.112.122.20 list=DNSoHTTPS 
add address=149.112.121.30 list=DNSoHTTPS 
add address=149.112.122.30 list=DNSoHTTPS 

# ordns.he.net
add address=74.82.42.42 list=DNSoHTTPS 

# dns.alidns.com
add address=223.5.5.5 list=DNSoHTTPS 
add address=223.6.6.6 list=DNSoHTTPS 

# dns.switch.ch
add address=130.59.31.251 list=DNSoHTTPS 
add address=130.59.31.248 list=DNSoHTTPS 

# *.blahdns.com
add address=45.90.57.121 list=DNSoHTTPS 
add address=95.216.212.177 list=DNSoHTTPS 
add address=78.46.244.143 list=DNSoHTTPS 
add address=139.162.112.47 list=DNSoHTTPS 
add address=192.53.175.149 list=DNSoHTTPS 

# dnsbycomodo.com
add address=8.26.56.26 list=DNSoHTTPS 
add address=8.20.247.20 list=DNSoHTTPS 

# dns.mrkaran.dev
add address=139.59.55.13 list=DNSoHTTPS 

# dns.dns-over-https.com
add address=104.24.122.53 list=DNSoHTTPS 
add address=104.24.123.53 list=DNSoHTTPS 

# jarjar.meganerd.nl
add address=209.250.241.25 list=DNSoHTTPS 

# adfree.usableprivacy.net
add address=149.154.153.153 list=DNSoHTTPS 

# dns.dnshome.de
add address=185.233.106.232 list=DNSoHTTPS 
add address=185.233.107.4 list=DNSoHTTPS 

# doh.abmb.win / doh2.abmb.win
add address=3.0.59.48 list=DNSoHTTPS 
add address=54.169.103.244 list=DNSoHTTPS 
add address=172.67.153.154 list=DNSoHTTPS 
add address=104.28.13.215 list=DNSoHTTPS 
add address=104.28.12.215 list=DNSoHTTPS 

# dns.decloudus.com
add address=176.9.199.158 list=DNSoHTTPS 

# rdns.faelix.net
add address=46.227.200.54 list=DNSoHTTPS 
add address=46.227.200.55 list=DNSoHTTPS 
add address=185.134.196.54 list=DNSoHTTPS 
add address=185.134.197.54 list=DNSoHTTPS 

# pdns.faelix.net
add address=46.227.200.52 list=DNSoHTTPS 
add address=46.227.203.52 list=DNSoHTTPS 
add address=185.134.196.52 list=DNSoHTTPS 

# *.dismail.de
add address=80.241.218.68 list=DNSoHTTPS 
add address=159.69.114.157 list=DNSoHTTPS 

# *.censurfridns.dk
add address=91.239.100.100 list=DNSoHTTPS 
add address=130.225.244.166 list=DNSoHTTPS 
add address=130.226.161.34 list=DNSoHTTPS 
add address=185.38.24.52 list=DNSoHTTPS 
add address=198.180.150.12 list=DNSoHTTPS 
add address=89.233.43.71 list=DNSoHTTPS 

# *.seby.io
add address=45.76.113.31 list=DNSoHTTPS 
add address=139.99.222.72 list=DNSoHTTPS 
/log info "DNSoHTTPS list Populated"
